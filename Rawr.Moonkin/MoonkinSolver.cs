using System;
using System.Collections.Generic;

namespace Rawr.Moonkin
{
    // The interface public class to the rest of Rawr.  Provides a single Solve method that runs all the calculations.
    public class MoonkinSolver
    {
        private const int NUM_SPELL_DETAILS = 17;
        // A list of all currently active proc effects.
        public List<ProcEffect> procEffects;
        public static float BaseMana = 18635f;
        public static float OOC_PROC_CHANCE = 0.0583f;
        public static float EUPHORIA_PERCENT = 0.08f;
        public static float DRAGONWRATH_PROC_RATE = 0.11f;
        public static float ECLIPSE_BASE = 0.25f;

        #region Cast Distributions

        #region No GoSF

        public static double[,] CastDistribution = new double[21, 12] {
{ 0.104433029595219, 0.161825976594847, 0.0275195408859163, 0.0475166805018416, 0.132718457803961, 0.209531309373631, 0.0332709453500805, 0.0605830061271891, 0.0498481736221563, 0.0783668314933563, 0.0612298111236319, 0.0331562375281703, },
{ 0.102994400072861, 0.166764985443026, 0.0263139295093245, 0.0504240410713653, 0.14232313963262, 0.202260506139241, 0.03087477802826, 0.0611048062320821, 0.0456792459450158, 0.0783767524623182, 0.0612230882727025, 0.031660327191184, },
{ 0.11129645710543, 0.171451426798479, 0.0234714557905631, 0.0466111626987339, 0.139982454183865, 0.21701396017554, 0.0297158320354779, 0.0609718098095745, 0.0396747416241819, 0.0666985443565413, 0.0597697884240399, 0.0333423669975737, },
{ 0.111310886660795, 0.173175826674901, 0.0226790121417946, 0.0501693634794773, 0.147487723531036, 0.211662285655252, 0.0267771551651823, 0.0611131560761429, 0.0371080994858704, 0.0713038871754228, 0.0603837461504832, 0.0268288578036426, },
{ 0.119328619555823, 0.174832483776299, 0.0214721001794153, 0.047257455608299, 0.145451854761125, 0.224608992837491, 0.0252407525476473, 0.0610865724175048, 0.0364774479196927, 0.0591313417710435, 0.0538725074795078, 0.0312398711461516, },
{ 0.118235752547291, 0.180847377779613, 0.0190313054324064, 0.0491219344754261, 0.152010915769052, 0.217448781634978, 0.024005572029235, 0.0620165847100576, 0.0344875594258354, 0.0611307442076739, 0.0531761875779462, 0.0284872844104854, },
{ 0.124523852396847, 0.180360141152225, 0.0188557891131089, 0.0474994609563535, 0.150204267911051, 0.230349475769406, 0.0219339966675353, 0.0601778212128547, 0.0339658810864914, 0.0539111825409507, 0.0490098837367166, 0.0292082474564592, },
{ 0.122866745680191, 0.186185509638666, 0.0168665926852044, 0.0497608660690753, 0.155362449373852, 0.223789250919518, 0.0209792988656704, 0.0622556094976498, 0.0316887378608934, 0.0542860608938812, 0.0484577321094886, 0.0275011464059101, },
{ 0.129619250583576, 0.184151433569786, 0.0163100724314596, 0.0490935025633857, 0.15452753745244, 0.234580481303649, 0.019805672460477, 0.0599086622135869, 0.0335965519225051, 0.0519909945146099, 0.0421495829433033, 0.0242662580412216, },
{ 0.126550995093533, 0.190126125193898, 0.0155341537009154, 0.0510772331386939, 0.155874530916288, 0.230964547306306, 0.0182389851656376, 0.0613646242296722, 0.0334501370422226, 0.0510392662650395, 0.0415705027741306, 0.0242088991736636, },
{ 0.133313658982272, 0.185478619282726, 0.0152561010684502, 0.0534149353093411, 0.158912701865275, 0.236901707454342, 0.0168620332748024, 0.0592622309479758, 0.0442843409414049, 0.0552841342819045, 0.0259493979232981, 0.0150801386682082, },
{ 0.129752977161124, 0.191313273799059, 0.0141729550542876, 0.0532178323187969, 0.155573320759828, 0.238684239513485, 0.0158349106409744, 0.0599131584614006, 0.0418476188732887, 0.0511811143848822, 0.0289162910271, 0.0195923080057733, },
{ 0.133103258067851, 0.191143214176809, 0.0119380272608049, 0.0526165844268675, 0.160478573590251, 0.23038553099718, 0.0166213418273065, 0.0651575863060852, 0.0222373676703492, 0.0498543497034308, 0.0467514733461236, 0.0197126926269415, },
{ 0.135943037121566, 0.189861455371006, 0.010043273831244, 0.0524111750501323, 0.157680648976091, 0.238001134867093, 0.0156740824367533, 0.065665698077953, 0.0238101194290115, 0.0436482635070056, 0.0435478883694719, 0.0237132229626716, },
{ 0.133655463943658, 0.19606729237318, 0.0108523855843651, 0.0523025577728379, 0.159238940276333, 0.23512454468824, 0.0147335983795081, 0.0667566371068175, 0.0219257902841444, 0.0385429748227262, 0.0436843545081185, 0.0271154602600711, },
{ 0.137444318075296, 0.198169952386748, 0.011519020745344, 0.0467851189686147, 0.164621027523857, 0.238163164018611, 0.0152961007724874, 0.0584778291833634, 0.0256091290121987, 0.0435855039883429, 0.0391479897447533, 0.0211808455803837, },
{ 0.139680294027228, 0.19477683522118, 0.0101079043783671, 0.049049872619602, 0.161363592202261, 0.238159183870219, 0.0154549662107681, 0.0638046079556778, 0.0245529928193804, 0.0421642057043466, 0.0392343610954697, 0.0216511838954998, },
{ 0.139265786688817, 0.194474669194778, 0.00945599407309084, 0.0503541011500903, 0.160943124578091, 0.243292368595391, 0.0147950484162291, 0.0623301005565511, 0.0262047139482943, 0.0419025563037501, 0.0361180163366698, 0.0208635201582476, },
{ 0.137021557789142, 0.197072398229232, 0.00946639854156729, 0.052750606418642, 0.159136568079189, 0.240369312741628, 0.0137931118466711, 0.0659256651579843, 0.0245590175792484, 0.0404663651600619, 0.037515281169955, 0.0219237172866788, },
{ 0.137103882651084, 0.198179619683881, 0.00934117782353817, 0.0544219098293364, 0.164142175628651, 0.2397998958716, 0.0130357908623508, 0.0646226696410378, 0.0251508336189947, 0.0400460266139712, 0.0344715504497987, 0.019684467325756, },
{ 0.137976057461515, 0.194640268834538, 0.00872844342974609, 0.0567085115516371, 0.164868542617614, 0.236415803296874, 0.0126478629610242, 0.0671258819940996, 0.0245976567854436, 0.041948669349176, 0.0349818571548727, 0.0193604445634601, },
};
        
        public static double[,] T12CastDistribution = new double[21, 12] {
{ 0.0957389131875714, 0.149503955809482, 0.0250668995223429, 0.0433048054921489, 0.151172601006563, 0.21336428490112, 0.0353959546053048, 0.0645581022615007, 0.0448494798860087, 0.0770726875089786, 0.0658420410948694, 0.0341302747241092, },
{ 0.0946133691038063, 0.151890710324619, 0.0236922818925342, 0.0457188673952425, 0.145102999839694, 0.225269036637993, 0.0329902441960741, 0.0656301747080115, 0.0404709900588396, 0.0736665160798451, 0.0656830651520193, 0.0352717446113213, },
{ 0.10328419743279, 0.155977605903325, 0.0219327478320021, 0.0427407797415198, 0.156700964140332, 0.223715233728381, 0.0314748599099165, 0.0647582391772637, 0.0366483502375645, 0.0650914524808552, 0.0627529331762044, 0.0349226362398455, },
{ 0.100507653483533, 0.160985555678548, 0.0203853619296055, 0.0452280138033132, 0.151924087674274, 0.232119428219167, 0.0284041141008962, 0.0660977215389675, 0.0344819883116757, 0.063901187594922, 0.0622585439540013, 0.0337063437110964, },
{ 0.108668371636408, 0.161985348435667, 0.0196976215458535, 0.0431450216221164, 0.161054258111907, 0.23399690633765, 0.0269368321939126, 0.0646222686169463, 0.0323620040792205, 0.0578856114047878, 0.0575802920828484, 0.0320654639326823, },
{ 0.105344256750643, 0.169311739729962, 0.01686797889786, 0.0446603064562687, 0.159762222160555, 0.236985695581593, 0.0257083051022567, 0.0661415046236639, 0.0304968351631671, 0.0580989618489412, 0.0558836908575946, 0.0307385028274952, },
{ 0.112710671382827, 0.166250803196269, 0.0175227870467561, 0.0430378183632021, 0.164149288311066, 0.244306151782873, 0.0232059739962738, 0.0639012944026083, 0.0302393584025097, 0.0524984192882748, 0.0521287110236607, 0.0300487228036787, },
{ 0.109520958116881, 0.172937284257907, 0.0152877674286031, 0.0454669209724546, 0.164869269042096, 0.2428633658101, 0.0220305921844676, 0.0663986038232406, 0.0301355419172053, 0.0534643881084233, 0.0493146642016183, 0.0277106441370033, },
{ 0.115308655609456, 0.169562626054276, 0.0159624440316827, 0.0460263086354458, 0.168187370759969, 0.25147301070972, 0.0202194607860813, 0.0620803147374828, 0.0410549984181032, 0.0559340625513012, 0.0342841077413264, 0.0199066399651558, },
{ 0.112847320775063, 0.174284617907911, 0.015121430819753, 0.0482237063296825, 0.168151274045593, 0.250815448942361, 0.0188493518606111, 0.0624169021068535, 0.0467417811286503, 0.0552149588525982, 0.0278086227623971, 0.0195245844685265, },
{ 0.119569447203282, 0.174353046391844, 0.011997834729445, 0.0453224544830948, 0.170379002971318, 0.251313540204566, 0.0195718833161156, 0.0675600730726363, 0.0214616495862502, 0.0442724199678639, 0.0484144571129366, 0.0257841909606487, },
{ 0.116212769324348, 0.179084847152149, 0.0111648610606161, 0.0457919214373829, 0.167729016730044, 0.253231488960563, 0.0183994024684392, 0.067519696188291, 0.0214015084148774, 0.0443947717362168, 0.049027014695477, 0.0260427018315951, },
{ 0.12038310309467, 0.176906396171442, 0.0098107221907228, 0.0469109175728745, 0.172500927099447, 0.246656666103094, 0.018020535925379, 0.0713401005957881, 0.0196015891596248, 0.0412619401268434, 0.0490209426624437, 0.0275861592976705, },
{ 0.120303834323121, 0.175886015058015, 0.00889278538131953, 0.0478577258263204, 0.170181865346636, 0.255785007873555, 0.0169261193648952, 0.0695588411637449, 0.0247653881226445, 0.0432003840645733, 0.0425337210665962, 0.0241083124085789, },
{ 0.118471028342685, 0.180240386580811, 0.00920530749764893, 0.0486987318740413, 0.172919122981396, 0.251850744382195, 0.016152432377462, 0.0713718014949462, 0.0228604678295827, 0.0423192927812883, 0.0426709863093928, 0.0232396975485502, },
{ 0.122700885245071, 0.182593294082697, 0.00992877623676082, 0.0429670620434442, 0.176706376471467, 0.256162390588555, 0.0166444706520162, 0.062850690131245, 0.0249979765731243, 0.0427694467631249, 0.0397189688988795, 0.0219596623136156, },
{ 0.122442433338114, 0.179850447807779, 0.00927594797003311, 0.0452643089083629, 0.173100027751387, 0.259187240952949, 0.0161886644025114, 0.0673308909180967, 0.0237194215072271, 0.042839208823064, 0.0399453780075968, 0.0208560296128778, },
{ 0.121836501484675, 0.182037462963433, 0.008573947852736, 0.0457224743776338, 0.172920945998392, 0.261039697985664, 0.0154789694259698, 0.0670062562613945, 0.024735169063154, 0.0406433318456846, 0.0377537882898401, 0.0222514544514235, },
{ 0.120369950839805, 0.182870682506548, 0.00847797524581759, 0.0483907789692829, 0.173702838066989, 0.256944149328579, 0.0146663017456171, 0.0700021844158959, 0.0245142675747736, 0.0406199970795611, 0.0376832266301136, 0.0217576475970166, },
{ 0.122110904789227, 0.182223942360298, 0.00812092376260005, 0.0494951693966772, 0.178489122310804, 0.256493229422299, 0.0139931620492359, 0.0693808720986947, 0.0234110847035787, 0.0393052089735099, 0.0363124164155651, 0.0206639637175092, },
{ 0.123652529151886, 0.178649030648865, 0.00783321105823559, 0.0515208721372196, 0.176889073476318, 0.255150849756165, 0.0133580269223821, 0.0724010513550528, 0.0223118989631267, 0.0397768074425981, 0.0369653741638552, 0.0214912749242951, },
};
        public static double[,] T13CastDistribution = new double[21, 12] {
{ 0.0952099426062039, 0.147892264931236, 0.0295132923680463, 0.0436928571340766, 0.152029370410546, 0.214733732391818, 0.031127846322907, 0.0639340296228091, 0.0459095947821539, 0.0772414935221961, 0.0647712193208495, 0.0339443565871571, },
{ 0.0941231072994148, 0.149674367454132, 0.027904872135205, 0.0463484593225765, 0.146520640888411, 0.226570542187483, 0.0289258627907554, 0.0647843239906357, 0.0409781846004271, 0.0737817359191693, 0.0652376653474755, 0.0351502380643145, },
{ 0.102542351477203, 0.156394891155868, 0.0255984520351627, 0.0439093214087032, 0.156679459975993, 0.223139036373911, 0.027613508953342, 0.0640112199718772, 0.037667897506182, 0.0659917145146516, 0.0620658487472574, 0.0343862978798482, },
{ 0.102428315399747, 0.156149035739729, 0.0252422783057017, 0.0463164397458605, 0.152023772307274, 0.234592489909274, 0.0236093707785485, 0.0648970302096963, 0.0363623711190796, 0.0656333201576731, 0.0604857614766544, 0.0322598148507612, },
{ 0.108682960662791, 0.162191645760077, 0.0244744863987921, 0.0445403795378409, 0.161221071724488, 0.233213141636104, 0.0223495548857327, 0.0632621223938616, 0.0351958600269009, 0.0595204298301758, 0.0548304589981029, 0.0305178881451336, },
{ 0.108566476177599, 0.166166526788611, 0.0212866538582566, 0.0460390099792787, 0.156875111995931, 0.239347797736092, 0.0212970292740178, 0.0648301880072669, 0.0327929432150704, 0.0590338836806012, 0.0538449039493858, 0.0299194753378902, },
{ 0.114071318319885, 0.167876265230961, 0.0212810119786646, 0.0448683187573873, 0.164491027168958, 0.240479163751682, 0.0193981309846266, 0.0623377158827824, 0.0339773527546609, 0.0549871762606044, 0.0485250420667234, 0.0277074768430648, },
{ 0.112986993327831, 0.171249054842344, 0.0189921937803152, 0.0470131762184076, 0.161142321529059, 0.244493205762908, 0.0183462027195328, 0.0649986144628633, 0.0324218994581752, 0.0542915407896083, 0.0471197318805635, 0.0269450652283922, },
{ 0.116637451974043, 0.171388123453645, 0.0192649350505695, 0.0475884835975393, 0.16826799732746, 0.247952141232526, 0.0168470510750458, 0.060910015225765, 0.0428390001173556, 0.0572089756953136, 0.0324803229990206, 0.0186155022517159, },
{ 0.117112529160879, 0.171296297962275, 0.0182879565763348, 0.0492388933067395, 0.165221954506458, 0.251588640100035, 0.0155327346010229, 0.0621926805869093, 0.043383066182517, 0.0553420477272033, 0.0312794613500887, 0.0195237379395372, },
{ 0.122140003766313, 0.178776756160221, 0.0149826343858291, 0.0465676408969371, 0.168712084709858, 0.245352055109054, 0.0167895203843697, 0.0665757985160803, 0.0192813179316738, 0.0431065627951693, 0.050700514406931, 0.0270151109375628, },
{ 0.123115293039595, 0.17709432586417, 0.0139566452176178, 0.0470328962459322, 0.166346895674721, 0.24864924708399, 0.0158544727918497, 0.0663774765438117, 0.0220845245310276, 0.0451415668160487, 0.0486976941229527, 0.0256489620682841, },
{ 0.123269453744843, 0.180494257538675, 0.0121226641257659, 0.0483133276315369, 0.166738331891969, 0.245729935675372, 0.0158569321314533, 0.0698239091437963, 0.0195634616736786, 0.0404222317360134, 0.0490202468375547, 0.0286452478693416, },
{ 0.125911477718955, 0.17980250761014, 0.010343947348485, 0.0496236771053283, 0.169500342642397, 0.246427457835319, 0.015248344659091, 0.0683691579184884, 0.023282712825365, 0.0436910702294447, 0.0440991839068961, 0.0237001202000908, },
{ 0.12646696011952, 0.179549955738032, 0.0107093670657843, 0.0498904682497161, 0.166595605904611, 0.251031664179187, 0.014821853472659, 0.069730717509883, 0.0224531762394364, 0.0416134252297902, 0.0431409007369127, 0.0239959055544697, },
{ 0.126012751391459, 0.188486224521317, 0.0113585723628227, 0.0442247579962654, 0.169547119034672, 0.254611901382163, 0.0155399795028679, 0.0609316656182064, 0.0246463356127047, 0.0429173838023209, 0.0399939890523182, 0.0217293197228826, },
{ 0.128168228858125, 0.185876029761056, 0.00964620541667187, 0.046796941254773, 0.171399908370357, 0.248793301192901, 0.016001668340413, 0.0658488880517071, 0.024345757913001, 0.0429136160052642, 0.0393637736573688, 0.0208456811783623, },
{ 0.130942148886967, 0.184100722975953, 0.0087583152708899, 0.0475651144512838, 0.172199259175843, 0.250268295029434, 0.0154385245056106, 0.0653823374387186, 0.0250549846931105, 0.0408330152260182, 0.0373862904712757, 0.0220709918748955, },
{ 0.130600587745878, 0.180878703039098, 0.0086619330430314, 0.0496024656011839, 0.169619082019856, 0.252327635097478, 0.0148206925089009, 0.0687566969303582, 0.0237816097209439, 0.0410755589975186, 0.0384941638186919, 0.0213808714770615, },
{ 0.12965026666443, 0.183735059219811, 0.00842562831051573, 0.0510553525346738, 0.170600472028969, 0.255066556606114, 0.0138568485776078, 0.0680581295720108, 0.0238656220171853, 0.0391558366691005, 0.0358150924380304, 0.0207151353615507, },
{ 0.129178259436966, 0.182012879719443, 0.00773475299840835, 0.0531067975382641, 0.171376173836267, 0.251416478000357, 0.0136333416430935, 0.0708231207012469, 0.0229701312848622, 0.0396422154186693, 0.0364699900412499, 0.0216358593811729, },
};
        public static double[] BaseRotationDurations = new double[21] { 60.989962236025, 57.6778147116241, 53.873720909091, 51.1282637345095, 48.2750338607084, 45.8138609020291, 43.5595013823855, 41.7336724678669, 40.0166828673067, 38.6378048135025, 37.0806741176986, 36.0406820012949, 34.8923915475193, 33.8946865754536, 32.9475106354515, 32.3041953908947, 31.7816008961088, 31.4268673490786, 31.0035434830552, 30.6247117526145, 30.2799107813664, };
        public static double[] T12RotationDurations = new double[21] { 56.3380863136643, 53.2619055486541, 49.7908228634166, 47.1661458533919, 44.5458951111109, 42.2235754245059, 40.1232987327455, 38.4829168584396, 36.9016773931863, 35.6443430607774, 34.2371478833146, 33.2654519208421, 32.1623871255374, 31.422003114277, 30.5141879693094, 29.9424753029282, 29.4514265829307, 29.136461990879, 28.7338319698703, 28.3882673030472, 28.07361967971, };
        public static double[] T13RotationDurations = new double[21] { 56.5526227670808, 53.3477853412866, 50.2274696837945, 47.5128989195546, 45.0767804798708, 42.7788890030038, 40.736953478869, 39.0508623364074, 37.4346361048376, 36.144724721905, 35.0062115674471, 34.10428298075, 32.8955503565454, 32.139961655446, 31.2116343014159, 30.7522707601485, 30.2126024085575, 29.8652713090483, 29.4224483164432, 29.0723344276423, 28.7132382009836, };
        public static double[] BaseNGUptimes = new double[21] { 0.480990118856201, 0.492800554700838, 0.543596011628719, 0.570973960940929, 0.589003508840932, 0.641411058748092, 0.660409977651369, 0.700611444628149, 0.719282373554618, 0.747459731717875, 0.773051068111661, 0.795325251255784, 0.816071951154998, 0.827378719791146, 0.85074623183832, 0.814390334742635, 0.845045105476324, 0.808053931628142, 0.845812108677301, 0.800777932824308, 0.837231260535001, };
        public static double[] T12NGUptimes = new double[21] { 0.519824432130538, 0.533726857601935, 0.582611063177825, 0.616949409580761, 0.638232284968279, 0.693865812151969, 0.718630826434904, 0.755491566627226, 0.772970956642567, 0.799957302116416, 0.81535485159219, 0.835386154238662, 0.870935792363279, 0.825891039175511, 0.858740800296245, 0.812710092188888, 0.853613118297824, 0.809662347803527, 0.853007550530364, 0.801396593148055, 0.853159813958059, };
        public static double[] T13NGUptimes = new double[21] { 0.517876789900339, 0.532506940522383, 0.578547700826359, 0.612908023330379, 0.629616886409011, 0.685396673112203, 0.706726470475339, 0.745452228393809, 0.761394865715459, 0.790961563582442, 0.800747409310569, 0.805747142443137, 0.864406815910761, 0.826557895572829, 0.857035514555104, 0.812809606041758, 0.85165990413495, 0.80953750733768, 0.851788566898828, 0.800254394095889, 0.848159425104494, };

        #endregion

        #region With GoSF

        public static double[,] CastDistributionGoSF = new double[21, 12] {
{ 0.105493942361288, 0.173855887185751, 0.0290072627547423, 0.0506036761479185, 0.138565766448547, 0.213482805296731, 0.0327031417659145, 0.0604737269099007, 0.0425165375617514, 0.0792950249408867, 0.0406635748438857, 0.0333386537826834, },
{ 0.114777049473542, 0.170161032250869, 0.0283199463507017, 0.0511475286515298, 0.147953288890437, 0.21273952153893, 0.0306870311198533, 0.0596356462159195, 0.0506911389161202, 0.0794725121281888, 0.0216339058579751, 0.0327813986059336, },
{ 0.113058695631949, 0.181840353455352, 0.0256754249756919, 0.051036133149874, 0.146507555602091, 0.223643655055009, 0.0289062179821954, 0.0585304545226316, 0.0575011615649673, 0.071317876918441, 0.0123902944132195, 0.0295921767285794, },
{ 0.1201261196797, 0.176126609008259, 0.0238999668747563, 0.0512247489440728, 0.153324639148878, 0.219045222924165, 0.0276525315364002, 0.058157351877301, 0.0620970226981305, 0.0723706474415435, 0.00659434919443339, 0.0293807906723605, },
{ 0.119370945259614, 0.182607448889004, 0.0231725707621034, 0.0519339458638882, 0.149059757709061, 0.230761490418575, 0.0243185063195438, 0.0585769604817966, 0.0597051244174199, 0.0603297185326358, 0.00962315242450215, 0.030540378921855, },
{ 0.124689086799998, 0.180559379066286, 0.0212844461273422, 0.0517490289892308, 0.156996887237348, 0.223081857304197, 0.0225679405739133, 0.0602861923178746, 0.048635584540291, 0.0609954088181748, 0.0195515462858214, 0.0296026419395226, },
{ 0.126033166630227, 0.185224733547599, 0.0191758636107939, 0.0499416374836676, 0.151549024748, 0.233154614263715, 0.0220952948609987, 0.0621142233922142, 0.0317319952956232, 0.0547738485208388, 0.035172672415408, 0.0290329252309151, },
{ 0.128599934455939, 0.187832453992669, 0.0171511291190222, 0.0505291721615097, 0.158908047819884, 0.227017724148531, 0.0211713735768506, 0.0634020636395253, 0.0269353667558765, 0.0540396866203082, 0.0358719963508016, 0.0285410513590823, },
{ 0.130633510142616, 0.18801958084021, 0.0160702714809375, 0.0510228389816469, 0.155076131074564, 0.237700309018187, 0.0203112936649478, 0.0630902355336935, 0.0280627746297871, 0.0525764300759256, 0.0318561691141038, 0.025580455443381, },
{ 0.130722397581628, 0.192705988810929, 0.0157115295120173, 0.0518075529577947, 0.162001227126553, 0.233012931261579, 0.0187468672483327, 0.0630796454530493, 0.0276444254953083, 0.0513037504392562, 0.0285183989062141, 0.0247452852073389, },
{ 0.13483138495401, 0.189836703579432, 0.0147224313578582, 0.0539723773306334, 0.160229740131455, 0.241003844585387, 0.0178188668704033, 0.0625728570376008, 0.0257028684713834, 0.0550657936401743, 0.0282634675623626, 0.0159796644793001, },
{ 0.131475035363574, 0.196880209791339, 0.0135676774750857, 0.0544859020566519, 0.159127660983851, 0.239414343571695, 0.016838172203505, 0.0625539261349771, 0.0260664522420903, 0.0535866026809168, 0.0281058472386917, 0.0178981702576232, },
{ 0.135888096596175, 0.193047812201173, 0.0126975364544638, 0.0540575286178645, 0.163757330513968, 0.236958744762071, 0.0164403596546824, 0.0637381335737421, 0.0229766310529182, 0.0526366718434528, 0.0295715070841019, 0.0182296476453879, },
{ 0.136138440201982, 0.194909267346544, 0.0107615037183394, 0.0543452889509882, 0.159052482348143, 0.242299682432946, 0.0160544794783937, 0.0666137885290265, 0.0202538069933094, 0.045607096514201, 0.031771722836925, 0.0221924406492022, },
{ 0.13599488153927, 0.198336446933364, 0.0112544297666473, 0.0538267973061476, 0.164916612432528, 0.238770240561753, 0.0149780831566658, 0.0655088879349207, 0.0193908561641023, 0.0437629708907763, 0.0306392030596629, 0.0226205902541618, },
{ 0.141376356903775, 0.199302138880756, 0.0116366158414919, 0.0486061793642381, 0.165484006542555, 0.241745893690905, 0.0162166913780079, 0.0604669816859003, 0.0196683711380146, 0.0446422229695275, 0.0303089291858089, 0.0205456124190194, },
{ 0.140530262796744, 0.197465362255438, 0.0102855371535008, 0.0508388345515539, 0.1629336443732, 0.246294678385523, 0.0155259745339224, 0.0633652777360263, 0.0212204354332536, 0.04382688187361, 0.0272830253988554, 0.020430085508372, },
{ 0.139146146036553, 0.199318014429982, 0.00972090701215454, 0.0530112870918789, 0.161788264248817, 0.246033873314347, 0.0147681691189478, 0.0639404713595686, 0.0209858154815691, 0.0433328092133406, 0.0278092050449672, 0.0201450376478745, },
{ 0.137887905847028, 0.201205892845886, 0.0096237667700799, 0.054161964365681, 0.163957566038484, 0.242965186289158, 0.0138020394803812, 0.0654247619722868, 0.021455396267298, 0.0420922536845663, 0.0267555264466504, 0.0206677399925006, },
{ 0.139027125412221, 0.198820006038661, 0.00889726621228637, 0.0563124145398107, 0.166763628660149, 0.240353613448238, 0.0132872733066099, 0.0666489871505326, 0.0218583613762417, 0.0428324866267624, 0.0260142894627458, 0.0191845477657415, },
{ 0.142045299392658, 0.196100522905822, 0.00875445093409209, 0.0575119879398136, 0.166810894509129, 0.239552981198667, 0.012642923400272, 0.0676358493243648, 0.0212417741140756, 0.0417034018256944, 0.0261247400359432, 0.0198751744194684, },
};
        public static double[,] T12CastDistributionGoSF = new double[21, 12] {
{ 0.100541053235696, 0.152110818610709, 0.0263457327112079, 0.0456230297608439, 0.154142420983978, 0.232144814254432, 0.0358550677146954, 0.0645562917511893, 0.0501087358048127, 0.0757388916083677, 0.0260657343904769, 0.0367674091735919, },
{ 0.0964706037272869, 0.161517495180436, 0.0263539583410804, 0.0468401960181916, 0.158131591708275, 0.2317677597093, 0.0323326413676259, 0.0631031371490339, 0.0597183212015028, 0.0757574845197831, 0.0123707515810648, 0.0356360594964204, },
{ 0.105432116399743, 0.156967125561627, 0.0241786649551539, 0.0468197046261881, 0.15932708555757, 0.2406775699297, 0.0300370415277613, 0.0629054197813541, 0.0619015696077792, 0.0655238729184952, 0.0108814410467295, 0.0353483880878989, },
{ 0.103092161321155, 0.164664484491203, 0.021655310130536, 0.0471750777269057, 0.161838225623709, 0.236815911699577, 0.0284141991253798, 0.0639660268242791, 0.0533891646064211, 0.0658400021921705, 0.0191806405768361, 0.0339687956818272, },
{ 0.111002008866431, 0.162156570298451, 0.0199783943353387, 0.0463819603271497, 0.162262096432323, 0.242347680337645, 0.0265300919649321, 0.0665405726451388, 0.0358555555246549, 0.0586615685459324, 0.0359696793339883, 0.0323138213880153, },
{ 0.109280569009453, 0.171332222597552, 0.0176041595992571, 0.0450885263200388, 0.166620875423873, 0.240007366474614, 0.0257824616438257, 0.0673183448614378, 0.0274162400324087, 0.0567501725939545, 0.0399454279360615, 0.032853633507524, },
{ 0.113865936453752, 0.171382799994058, 0.0170068263146278, 0.0449586870118691, 0.164955796572421, 0.251108536613459, 0.0240818052570814, 0.0666997261913951, 0.0278121403015406, 0.0534257984764576, 0.0349032633422221, 0.0297986834711171, },
{ 0.113957955553641, 0.175759296846302, 0.0156431846314264, 0.0457825679640491, 0.172105608001952, 0.246511144285454, 0.0227656822967777, 0.066706870033052, 0.0282779633432899, 0.0532472213606283, 0.0303586281228492, 0.0288838775605787, },
{ 0.116748198593865, 0.174247531313203, 0.0146363326739957, 0.0462381994305612, 0.168396945554046, 0.255687849288339, 0.0216229025306802, 0.0669650073474265, 0.0287983862996922, 0.050163039879237, 0.0290315669308917, 0.027464040158062, },
{ 0.11447588661821, 0.178231271654684, 0.0149217587862178, 0.0487113810266194, 0.173021348672402, 0.25270124096717, 0.019418910582825, 0.0655731469496934, 0.0255935798034514, 0.0578405647107309, 0.0316603745047152, 0.0178505357232813, },
{ 0.120583501997256, 0.177185229722663, 0.0120786186293521, 0.0470551414451947, 0.171771083304511, 0.257525744307987, 0.0201218644416005, 0.0694665307824561, 0.0178169179242055, 0.0461889211604693, 0.0357503641864349, 0.0244560820978702, },
{ 0.117824502344699, 0.182493390185235, 0.0111460902074083, 0.0476814002193565, 0.172418136803637, 0.254648321784446, 0.0190205688465569, 0.069770585332919, 0.0179235307085352, 0.0461204723186293, 0.0359438563276595, 0.0250091449209178, },
{ 0.122867826433552, 0.179090091973521, 0.0107138510009292, 0.0480825860828967, 0.175345944300025, 0.254669002909843, 0.0182073651235098, 0.0694271016796672, 0.0202744730052016, 0.0455681132421883, 0.0305518654863389, 0.0252017787623276, },
{ 0.120567254441381, 0.181408657144185, 0.00951033667173503, 0.0499613607838141, 0.172169440133227, 0.259678926897584, 0.0171715958815386, 0.0714617731981694, 0.020138063143458, 0.0447317488890928, 0.0302233017667226, 0.0229775410490926, },
{ 0.122183814523846, 0.18249868613181, 0.00978013894536398, 0.0492851731493374, 0.178410999690969, 0.256682816491433, 0.0165240696331507, 0.0697771488339288, 0.020395795236459, 0.0443368940549583, 0.0281522166144582, 0.0219722466942853, },
{ 0.124973417078943, 0.183708697267331, 0.0100894958019371, 0.0444815777068943, 0.177298705961278, 0.263380475891066, 0.0175364739241618, 0.064869976030301, 0.0201480527949544, 0.0430003442257018, 0.0284948567385952, 0.0220179265788359, },
{ 0.123032457843787, 0.18568246595725, 0.00920028595113108, 0.046363700951334, 0.175303150644175, 0.264854865822793, 0.0163971732466655, 0.0677217038440102, 0.0200917800451271, 0.0420137224665418, 0.0273178862428798, 0.0220208069843058, },
{ 0.121913858769811, 0.186777690402175, 0.00868331787270521, 0.0479915869935257, 0.176014441566609, 0.262226815213376, 0.0157183021775467, 0.0687607282714475, 0.0207707729542617, 0.0413850813931434, 0.0277716257834337, 0.0219857786019645, },
{ 0.122801315990395, 0.185263982806646, 0.008302806643763, 0.0491220613041175, 0.17973298694597, 0.258749779310978, 0.0148367716119115, 0.0705084338872546, 0.0206822725443927, 0.0406181659151353, 0.0273222431584739, 0.0220591798809622, },
{ 0.12499516005723, 0.182657920935588, 0.00804430975607233, 0.0509108936086787, 0.179453651588711, 0.258487347702397, 0.0140705819962604, 0.0718098108096826, 0.0197677940971425, 0.0405479582861004, 0.0280022244058081, 0.0212523467563288, },
{ 0.125702877869753, 0.180111112735096, 0.00796560258068633, 0.0520974673483903, 0.178125868900821, 0.261153379052188, 0.013290430260649, 0.0728000489203018, 0.0198334998381948, 0.0396541762375475, 0.027443832576263, 0.0218217036801094, },
};
        public static double[,] T13CastDistributionGoSF = new double[21, 12] {
{ 0.0993095518359017, 0.150414828705812, 0.0306917592522201, 0.0465568423544081, 0.155047542497754, 0.23229196613413, 0.0309877963700452, 0.0642708761210875, 0.0481410613249168, 0.0760634345739619, 0.0298317114284366, 0.0363926294013264, },
{ 0.0955629441387914, 0.159177064437408, 0.0306749169020199, 0.0471187583036104, 0.15872352390461, 0.233590690345052, 0.0279273157515567, 0.062893110081121, 0.0573377365562218, 0.0758643762367597, 0.0156406388595333, 0.0354889244833159, },
{ 0.105452263009022, 0.154549260876567, 0.0289754630347532, 0.0475556806365615, 0.16003370012873, 0.24172641298501, 0.0252050513421368, 0.06233071993909, 0.0610970568548906, 0.0669724636521488, 0.0119615257111652, 0.0341404018299251, },
{ 0.104674395009273, 0.160935505754044, 0.0267987239447007, 0.0478199832739974, 0.160738309693062, 0.240078092777135, 0.0232730788060193, 0.0630502769570402, 0.0544525039185021, 0.0671053854367387, 0.0179892072855928, 0.033084537143895, },
{ 0.113192329209969, 0.160077084898362, 0.0249221446790465, 0.0477236707525436, 0.163512856129218, 0.241840309458591, 0.0217725843785484, 0.064520209060348, 0.0412808750623022, 0.0602172946687527, 0.0301257632203846, 0.0308148784819345, },
{ 0.111751056685696, 0.169277941665388, 0.022264768029147, 0.0469321346712571, 0.162626528341321, 0.242681466958176, 0.0209923971913888, 0.0655466658953489, 0.0321337979104071, 0.0580916331620152, 0.0361367617348873, 0.031564847754967, },
{ 0.117484513687439, 0.169495539062379, 0.0212565985111162, 0.0467470042042195, 0.165537443606966, 0.247040101876234, 0.0198053632146696, 0.0655668372296877, 0.0292791438968502, 0.0557236231125702, 0.0343093665668699, 0.027754465030998, },
{ 0.115941889419694, 0.176434536268239, 0.0193719406619536, 0.0474212588424947, 0.166828780481387, 0.248007967910177, 0.0187591647903598, 0.0655627725097534, 0.0283300360328516, 0.0542025880137531, 0.0312979362016148, 0.0278411288677216, },
{ 0.120632962197373, 0.17412859198714, 0.0185166696468118, 0.0482435394587527, 0.168969717962305, 0.250018680691864, 0.017748657414264, 0.0652738599207637, 0.029327000340189, 0.0535074543549333, 0.0292392628676868, 0.0243936031579171, },
{ 0.117996383626231, 0.178157030025768, 0.0182288172614241, 0.0498232597338418, 0.168628266548723, 0.254000841983854, 0.0160399573200677, 0.064686170554056, 0.0274002436334736, 0.05595720302926, 0.0293686268332553, 0.0197131994500462, },
{ 0.125122554045082, 0.179688628012652, 0.0153427245587039, 0.0487840358374308, 0.171867745626731, 0.249947782697613, 0.0169227120259546, 0.0676230634181355, 0.0203367237444833, 0.0459461395541857, 0.0336181212615855, 0.0247997692174435, },
{ 0.124293390688399, 0.18018043930521, 0.0142001033174992, 0.0492064099469248, 0.168270676657502, 0.254119693708622, 0.0161899975971748, 0.067804758679827, 0.0212011621442534, 0.046688372735339, 0.0332365251236133, 0.0246084700956353, },
{ 0.124962863284045, 0.183190852869842, 0.0130967870140639, 0.0496505193482292, 0.172053447057569, 0.250903706892637, 0.0156659454091712, 0.0684585190548476, 0.019915963680689, 0.0448195556894466, 0.0314170410536436, 0.0258647986458161, },
{ 0.127918367755054, 0.1810001311139, 0.0111159610271547, 0.0513912367797369, 0.171095092499661, 0.252823333549893, 0.0155735520516005, 0.0700100166294409, 0.0201350810489806, 0.0449859668272437, 0.0310857979338547, 0.0228654627834803, },
{ 0.127597992407703, 0.18461079695107, 0.0109590678631437, 0.0509560197702271, 0.170918614598836, 0.255772510879607, 0.0151769767100916, 0.0686116744297491, 0.0203823799455737, 0.0434992747623215, 0.028736420691859, 0.0227782709898184, },
{ 0.128229751086226, 0.191012931960311, 0.0111616483354288, 0.0459754407196146, 0.17401696672007, 0.255464466681216, 0.0166496302296313, 0.0630690191212209, 0.0204845740960883, 0.043989314526347, 0.0289091480983728, 0.0210371084254734, },
{ 0.131280388559831, 0.187745389492268, 0.00950927906784656, 0.0482285722656724, 0.174155064675961, 0.254433579018711, 0.0161956742594989, 0.0660478861087583, 0.0204897339835778, 0.0433747216423615, 0.0277001443390671, 0.0208395665864463, },
{ 0.131893456353855, 0.185255569238889, 0.00878604639534847, 0.0497037171237699, 0.172617604684361, 0.256615802501153, 0.0156462880671169, 0.0672438745872993, 0.020808387387634, 0.0413516697661574, 0.0279547226890336, 0.0221228612053811, },
{ 0.130905618634521, 0.185923584859478, 0.00858892245906321, 0.0508868560831297, 0.171775770625869, 0.25743545099681, 0.0148312723822529, 0.0688090258977865, 0.0206086552968669, 0.0410896489847778, 0.0275208658628999, 0.0216243279165443, },
{ 0.129984836822816, 0.18639824317227, 0.0080418160508828, 0.0528074941504643, 0.173056696445867, 0.255540795155921, 0.0141346586516241, 0.0702950435100416, 0.0204404832198572, 0.0415684806603754, 0.0273815526104139, 0.0203498995494656, },
{ 0.13135570004561, 0.184469221816155, 0.00778355504129804, 0.0538060800506438, 0.175533611134912, 0.253300567394315, 0.01348234028363, 0.0714612294637395, 0.020495887114556, 0.0402197176392711, 0.0268049786016698, 0.0212871114141991, },
};
        public static double[] BaseRotationDurationsGoSF = new double[21] { 59.4306549782608, 55.9789767494827, 52.5069717303471, 49.9572257088846, 47.4098468115939, 45.2214011176813, 43.1447124920105, 41.2446577578682, 39.6071471914174, 38.1031266693929, 36.7894688247694, 35.7655750235553, 34.6671580741362, 33.605664331948, 32.7177494106407, 32.0188904484338, 31.5062981042627, 31.1011746046666, 30.7202737007735, 30.3102142288053, 29.9867638356107, };
        public static double[] T12RotationDurationsGoSF = new double[21] { 54.6487885496894, 51.7921874856223, 48.7184833355287, 46.3880058928796, 43.9291847600644, 41.6692547756521, 39.6059937585892, 37.9325388747378, 36.465037781856, 35.3690845519551, 33.905811836492, 32.9710979831387, 31.9325899438604, 31.106622846371, 30.2406453981248, 29.5957616989058, 29.1346275213941, 28.7996586500196, 28.4187756517925, 28.0767537352286, 27.7627318213769, };
        public static double[] T13RotationDurationsGoSF = new double[21] { 54.7479649254657, 51.7790619116632, 48.8324626987263, 46.6226339138837, 44.3172854331719, 42.2618229944665, 40.2308848002432, 38.5607314565949, 37.112834376059, 35.8293409372585, 34.6013519420291, 33.704247802352, 32.6295561180124, 31.7891951228482, 30.9378411588584, 30.4019966057381, 29.9150029440994, 29.5014347647028, 29.1059089294433, 28.742910588151, 28.4087538373189, };
        public static double[] BaseNGUptimesGoSF = new double[21] { 0.493573424997453, 0.508189441099822, 0.555097437252594, 0.579544689776585, 0.59262027208033, 0.619287037901568, 0.630886621301388, 0.675767099873877, 0.6936372203455, 0.727399217156878, 0.727192063920661, 0.744207248179757, 0.761745171127465, 0.790574348156843, 0.797629464508127, 0.782314672717672, 0.791030411044615, 0.788446564175492, 0.795107926087214, 0.797105659183904, 0.788759157415204, };
        public static double[] T12NGUptimesGoSF = new double[21] { 0.534503620647449, 0.548648971358832, 0.584470310880904, 0.600315838355401, 0.618911631794181, 0.669158812723878, 0.696667958663069, 0.733487904560324, 0.755247798036357, 0.742236771046411, 0.777287975014463, 0.791030705295012, 0.807318235833063, 0.797424615019201, 0.808838319998262, 0.79589229465492, 0.812517220235224, 0.804051327117684, 0.813728433445724, 0.806216211207759, 0.79938371199683, };
        public static double[] T13NGUptimesGoSF = new double[21] { 0.53347727052412, 0.547997763026753, 0.584412969238537, 0.600558974136041, 0.613985983709373, 0.655770174957648, 0.681572324414671, 0.720456177467751, 0.737113869015254, 0.745264823394628, 0.770299611068377, 0.775782519460547, 0.803902509083828, 0.795738487370372, 0.804671218271745, 0.792768815602634, 0.802564258691974, 0.802726861805248, 0.808044430721418, 0.795558308726348, 0.795750943499299, };
        public static double[] BasePercentMoonfiresExtended = new double[21] { 0.605165893370135, 0.838647405299898, 0.880613947319479, 0.888533791144692, 0.785259889724261, 0.668768315789527, 0.563618385053623, 0.662471679198047, 0.736456626566521, 0.863855577276533, 0.912884152047087, 0.916150511278461, 0.908057869674344, 0.889329208020108, 0.911686010025218, 0.917250591478864, 0.951170751879904, 0.932509809524077, 0.964191809524038, 0.966434476190662, 0.978917238095393, };
        public static double[] T12PercentMoonfiresExtended = new double[21] { 0.823422013268379, 0.887419326453629, 0.831109309941491, 0.703729824561466, 0.553202987468713, 0.639810603782232, 0.754813273182982, 0.887159894737001, 0.896953318295919, 0.889023072681819, 0.878671157894815, 0.895075097744451, 0.959271373433829, 0.966772220551533, 0.980266631579083, 0.975149804511452, 0.983561157894838, 0.972598190476396, 0.98226428571444, 0.989197904761995, 0.973032380952614, };
        public static double[] T13PercentMoonfiresExtended = new double[21] { 0.770627367733029, 0.845015426802386, 0.804342529657445, 0.693831538847179, 0.588260656641633, 0.609802465254113, 0.722684392648378, 0.824774768588101, 0.858848138680028, 0.877994240601576, 0.870711976608241, 0.860495218045086, 0.929139874686915, 0.934363503759572, 0.93912536842125, 0.951994882205733, 0.967013228070357, 0.95043695238125, 0.949928761905069, 0.963341714285935, 0.981749428571567, };

        #endregion

        public static string[] CastDistributionSpells = new string[12] { "Starfire", "Wrath", "Starsurge", "Shooting Stars", "Starfire (Eclipse)", "Wrath (Eclipse)", "Starsurge (Eclipse)", "Shooting Stars (Eclipse)", "Moonfire", "Insect Swarm", "Moonfire (Eclipse)", "Insect Swarm (Eclipse)" };

        #endregion

        // A list of all the damage spells
        private Spell[] _spellData = null;
        private Spell[] SpellData
        {
            get
            {
                if (_spellData == null)
                {
                    _spellData = new Spell[] {
                        new Spell()
                        {
                            Name = "SF",
                            BaseDamage = (1214f + 1514f) / 2.0f,
                            SpellDamageModifier = 1.0f,
                            BaseCastTime = 3.2f,
                            BaseManaCost = (float)(int)(BaseMana * 0.11f),
                            DotEffect = null,
                            School = SpellSchool.Arcane,
                            BaseEnergy = 20
                        },
                        new Spell()
                        {
                            Name = "MF",
                            BaseDamage = (197.0f + 239.0f) / 2.0f,
                            SpellDamageModifier = 0.18f,
                            BaseCastTime = 1.5f,
                            BaseManaCost = (float)(int)(BaseMana * 0.09f),
                            DotEffect = new DotEffect()
                                {
                                    BaseDuration = 12.0f,
                                    BaseTickLength = 2.0f,
                                    TickDamage = 93.0f,
                                    SpellDamageModifierPerTick = 0.18f
                                },
                            School = SpellSchool.Arcane
                        },
                        new Spell()
                        {
                            Name = "W",
                            BaseDamage = (831f + 937f) / 2.0f,
                            SpellDamageModifier = 2.5f/3.5f,
                            BaseCastTime = 2.5f,
                            BaseManaCost = (float)(int)(BaseMana * 0.09f),
                            DotEffect = null,
                            School = SpellSchool.Nature,
                            BaseEnergy = 40/3f
                        },
                        new Spell()
                        {
                            Name = "IS",
                            BaseDamage = 0.0f,
                            SpellDamageModifier = 0.0f,
                            BaseCastTime = 1.5f,
                            BaseManaCost = (float)(int)(BaseMana * 0.08f),
                            DotEffect = new DotEffect()
                            {
                                BaseDuration = 12.0f,
                                BaseTickLength = 2.0f,
                                TickDamage = 136.0f,
                                SpellDamageModifierPerTick = 0.13f
                            },
                            School = SpellSchool.Nature
                        },
                        new Spell()
                        {
                            Name = "SS",
                            BaseDamage = (1018 + 1404) / 2f,
                            SpellDamageModifier = 1.228f,
                            BaseCastTime = 2.0f,
                            BaseManaCost = (float)(int)(BaseMana * 0.11f),
                            DotEffect = null,
                            School = SpellSchool.Spellstorm,
                            BaseEnergy = 15
                        }
                    };
                }
                return _spellData;
            }
        }
        public Spell Starfire
        {
            get
            {
                return SpellData[0];
            }
        }
        public Spell Moonfire
        {
            get
            {
                return SpellData[1];
            }
        }
        public Spell Wrath
        {
            get
            {
                return SpellData[2];
            }
        }
        public Spell InsectSwarm
        {
            get
            {
                return SpellData[3];
            }
        }
        public Spell Starsurge
        {
            get
            {
                return SpellData[4];
            }
        }
        private void ResetSpellList()
        {
            // Since the property rebuilding the array is based on this variable being null, this effectively forces a refresh
            _spellData = null;
        }

        // The spell rotations themselves.
        private SpellRotation[] rotations = null;
        public SpellRotation[] Rotations
        {
            get
            {
                if (rotations == null)
                {
                    rotations = new SpellRotation[3]
                    {
                        new SpellRotation() { RotationData = new RotationData() { Name = "Starfall Unused" } },
                        new SpellRotation() { RotationData = new RotationData() { Name = "Starfall Lunar Only", StarfallCastMode = StarfallMode.LunarOnly } },
                        new SpellRotation() { RotationData = new RotationData() { Name = "Starfall On CD", StarfallCastMode = StarfallMode.OnCooldown } },
                    };
                    //RecreateRotations();
                }
                return rotations;
            }
        }

        // Results data from the calculations, which will be sent to the UI.
        RotationData[] cachedResults = new RotationData[3];

        public void Solve(Character character, ref CharacterCalculationsMoonkin calcs)
        {
            CalculationOptionsMoonkin calcOpts = character.CalculationOptions as CalculationOptionsMoonkin;
            DruidTalents talents = character.DruidTalents;
            procEffects = new List<ProcEffect>();
            UpdateSpells(character, ref calcs);

            float trinketDPS = 0.0f;
            float baseSpellPower = calcs.SpellPower;
            float baseHit = 1 - Math.Max(0, calcs.SpellHitCap - calcs.SpellHit);
            float baseCrit = calcs.SpellCrit;
            float baseHaste = calcs.SpellHaste;
            float baseMastery = calcs.Mastery;
            float sub35PercentTime = (float)(character.BossOptions.Under20Perc + character.BossOptions.Under35Perc);

            BuildProcList(calcs);

            float maxDamageDone = 0.0f, maxBurstDamageDone = 0.0f;
            SpellRotation maxBurstRotation = Rotations[0];
            SpellRotation maxRotation = Rotations[0];

            float manaPool = GetEffectiveManaPool(character, calcOpts, calcs);

            float manaGained = manaPool - calcs.BasicStats.Mana;

            float oldArcaneMultiplier = calcs.BasicStats.BonusArcaneDamageMultiplier;
            float oldNatureMultiplier = calcs.BasicStats.BonusNatureDamageMultiplier;

            int rotationIndex = 1;
            foreach (SpellRotation rot in Rotations)
            {
                if (rot.RotationData.Name == "None") continue;
                rot.Solver = this;

                // Reset variables modified in the pre-loop to base values
                float currentSpellPower = baseSpellPower;
                float currentCrit = baseCrit + StatConversion.NPC_LEVEL_SPELL_CRIT_MOD[character.BossOptions.Level - character.Level];
                float currentHaste = baseHaste;
                float currentMastery = baseMastery;
                float currentTrinketDPS = trinketDPS;
                calcs.BasicStats.BonusArcaneDamageMultiplier = oldArcaneMultiplier;
                calcs.BasicStats.BonusNatureDamageMultiplier = oldNatureMultiplier;
                float accumulatedDamage = 0.0f;
                float totalUpTime = 0.0f;
                float[] spellDetails = new float[NUM_SPELL_DETAILS];
                List<ProcEffect> activatedEffects = new List<ProcEffect>();
                List<ProcEffect> alwaysUpEffects = new List<ProcEffect>();

                float baselineDPS = rot.DamageDone(character, calcs, calcOpts.TreantLifespan, currentSpellPower, baseHit, currentCrit, currentHaste, currentMastery, calcOpts.Latency);

                // Calculate spell power/spell damage modifying trinkets in a separate pre-loop
                // Add spell crit effects here as well, since they no longer affect timing
                foreach (ProcEffect proc in procEffects)
                {
                    bool handled = false;
                    if (proc.Effect.Stats.SpellPower > 0 || proc.Effect.Stats.CritRating > 0 || proc.Effect.Stats.MasteryRating > 0)
                    {
                        handled = true;
                        float procSpellPower = proc.Effect.Stats.SpellPower;
                        float procSpellCrit = StatConversion.GetSpellCritFromRating(proc.Effect.Stats.CritRating);
                        float procMastery = StatConversion.GetMasteryFromRating(proc.Effect.Stats.MasteryRating);

                        float triggerInterval = 0.0f, triggerChance = 1.0f;
                        switch (proc.Effect.Trigger)
                        {
                            case Trigger.DamageDone:
                            case Trigger.DamageOrHealingDone:
                                triggerInterval = ((rot.RotationData.Duration / rot.RotationData.CastCount) + (rot.RotationData.Duration / (rot.RotationData.MoonfireTicks + rot.RotationData.InsectSwarmTicks))) / 2.0f;
                                break;
                            case Trigger.Use:
                                break;
                            case Trigger.SpellHit:
                            case Trigger.DamageSpellHit:
                                triggerInterval = rot.RotationData.Duration / rot.RotationData.CastCount;
                                triggerChance = baseHit;
                                break;
                            case Trigger.SpellCrit:
                            case Trigger.DamageSpellCrit:
                                triggerInterval = rot.RotationData.Duration / (rot.RotationData.CastCount - rot.RotationData.InsectSwarmCasts);
                                triggerChance = baseCrit;
                                break;
                            case Trigger.SpellCast:
                            case Trigger.DamageSpellCast:
                                triggerInterval = rot.RotationData.Duration / rot.RotationData.CastCount;
                                break;
                            case Trigger.MoonfireCast:
                                triggerInterval = rot.RotationData.Duration / rot.RotationData.MoonfireCasts;
                                break;
                            case Trigger.DoTTick:
                                triggerInterval = rot.RotationData.Duration / (rot.RotationData.InsectSwarmTicks + rot.RotationData.MoonfireTicks);
                                break;
                            case Trigger.MoonfireTick:
                                triggerInterval = rot.RotationData.Duration / rot.RotationData.MoonfireTicks;
                                break;
                            case Trigger.InsectSwarmTick:
                                triggerInterval = rot.RotationData.Duration / rot.RotationData.InsectSwarmTicks;
                                break;
                            default:
                                triggerChance = 0.0f;
                                break;
                        }
                        if (triggerChance > 0)
                        {
                            float durationMultiplier = proc.Effect.LimitedToExecutePhase ? sub35PercentTime : 1f;
                            currentSpellPower += (proc.Effect.MaxStack > 1 ? proc.Effect.GetAverageStackSize(triggerInterval, triggerChance, 3.0f, character.BossOptions.BerserkTimer * 60.0f * durationMultiplier) : 1) *
                            proc.Effect.GetAverageUptime(triggerInterval, triggerChance, 3.0f, character.BossOptions.BerserkTimer * 60.0f) * procSpellPower * durationMultiplier;
                            currentCrit += (proc.Effect.MaxStack > 1 ? proc.Effect.GetAverageStackSize(triggerInterval, triggerChance, 3.0f, character.BossOptions.BerserkTimer * 60.0f * durationMultiplier) : 1) *
                                proc.Effect.GetAverageUptime(triggerInterval, triggerChance, 3.0f, character.BossOptions.BerserkTimer * 60.0f) * procSpellCrit * durationMultiplier;
                            currentMastery += (proc.Effect.MaxStack > 1 ? proc.Effect.GetAverageStackSize(triggerInterval, triggerChance, 3.0f, character.BossOptions.BerserkTimer * 60.0f * durationMultiplier) : 1) *
                                proc.Effect.GetAverageUptime(triggerInterval, triggerChance, 3.0f, character.BossOptions.BerserkTimer * 60.0f) * procMastery * durationMultiplier;
                        }
                    }
                    // 2T10 (both if statements, which is why it isn't else-if)
                    if (proc.Effect.Stats.BonusArcaneDamageMultiplier > 0)
                    {
                        handled = true;
                        calcs.BasicStats.BonusArcaneDamageMultiplier += proc.Effect.GetAverageUptime(rot.RotationData.Duration / rot.RotationData.CastCount, 1f, 3.0f, character.BossOptions.BerserkTimer * 60.0f) * proc.Effect.Stats.BonusArcaneDamageMultiplier;
                    }
                    if (proc.Effect.Stats.BonusNatureDamageMultiplier > 0)
                    {
                        handled = true;
                        calcs.BasicStats.BonusNatureDamageMultiplier += proc.Effect.GetAverageUptime(rot.RotationData.Duration / rot.RotationData.CastCount, 1f, 3.0f, character.BossOptions.BerserkTimer * 60.0f) * proc.Effect.Stats.BonusNatureDamageMultiplier;
                    }
                    // Variable Pulse Lightning Capacitor
                    // This might catch some other effects, I probably need a better way to differentiate
                    if (proc.Effect.Trigger == Trigger.DamageSpellCrit && proc.Effect.Stats.NatureDamage > 0)
                    {
                        float procInterval = rot.RotationData.Duration / (rot.RotationData.CastCount - rot.RotationData.InsectSwarmCasts + rot.RotationData.DotTicks);
                        currentTrinketDPS += proc.Effect.GetAverageProcsPerSecond(procInterval, currentCrit, 3.0f, character.BossOptions.BerserkTimer * 60.0f) * proc.Effect.Stats.NatureDamage;
                    }
                    // Nested special effects
                    if (proc.Effect.Stats._rawSpecialEffectDataSize > 0)
                    {
                        handled = true;
                        SpecialEffect childEffect = proc.Effect.Stats._rawSpecialEffectData[0];
                        // Heart of Ignacious
                        if (childEffect.Stats.SpellPower > 0)
                        {
                            float averageStack = childEffect.GetAverageStackSize(rot.RotationData.Duration / rot.RotationData.CastCount, baseHit, 3.0f, proc.Effect.Duration);
                            currentSpellPower += childEffect.Stats.SpellPower * averageStack * proc.Effect.GetAverageUptime(rot.RotationData.Duration / rot.RotationData.CastCount, baseHit);
                        }
                        // 4T11
                        if (childEffect.Stats.SpellCrit != 0)
                        {
                            float maxStack = proc.Effect.Stats.SpellCrit;
                            float numNegativeStacks = childEffect.GetAverageStackSize(rot.RotationData.Duration / (rot.RotationData.CastCount - rot.RotationData.InsectSwarmCasts), Math.Min(1.0f, baseCrit + maxStack), 3.0f, proc.Effect.Duration);
                            float averageNegativeValue = childEffect.Stats.SpellCrit * numNegativeStacks;
                            float averageCrit = maxStack + averageNegativeValue;
                            currentCrit += averageCrit * proc.Effect.GetAverageUptime(rot.RotationData.Duration / 2f, 1f, 3.0f, character.BossOptions.BerserkTimer * 60.0f);
                        }
                    }
                    if (!handled)
                    {
                        if (proc.CalculateDPS != null)
                        {
                            accumulatedDamage += proc.CalculateDPS(rot, calcs, character.BossOptions.BerserkTimer, currentSpellPower, baseHit, currentCrit, currentHaste) * rot.RotationData.Duration;
                        }
                        if (proc.Activate != null)
                        {
                            float upTime = proc.UpTime(rot, calcs, character.BossOptions.BerserkTimer, (float)(character.BossOptions.Under35Perc + character.BossOptions.Under20Perc));
                            // Procs with 100% uptime should be activated and not put into the combination loop
                            if (upTime == 1)
                            {
                                alwaysUpEffects.Add(proc);
                                proc.Activate(character, calcs, ref currentSpellPower, ref baseHit, ref currentCrit, ref currentHaste, ref currentMastery);
                            }
                            // Procs with uptime 0 < x < 100 should be activated
                            else if (upTime > 0)
                                activatedEffects.Add(proc);
                        }
                        if (proc.CalculateMP5 != null)
                        {
                            manaGained += proc.CalculateMP5(rot, calcs, character.BossOptions.BerserkTimer, currentSpellPower, baseHit, currentCrit, currentHaste) / 5.0f * character.BossOptions.BerserkTimer * 60.0f;
                        }
                    }
                }
                // Calculate stat-boosting trinkets, taking into effect interactions with other stat-boosting procs
                int sign = 1;
                float[] cachedDamages = new float[1 << activatedEffects.Count];
                float[] cachedUptimes = new float[1 << activatedEffects.Count];
                float[,] cachedDetails = new float[1 << activatedEffects.Count, NUM_SPELL_DETAILS];
                List<int> calculatedPairs = new List<int>();
                // Iterate over the entire set of trinket combinations (each trinket by itself, 2 at a time, ...)
                for (int i = 1; i <= activatedEffects.Count; ++i)
                {
                    // Create a new combination generator for this "level" of trinket interaction
                    CombinationGenerator gen = new CombinationGenerator(activatedEffects.Count, i);
                    // Iterate over all combinations
                    while (gen.HasNext())
                    {
                        float tempUpTime = 1.0f;
                        int[] vals = gen.GetNext();
                        int pairs = 0;
                        int lengthCounter = 0;
                        // Activate the trinkets, calculate the damage and uptime, then deactivate them
                        foreach (int idx in vals)
                        {
                            pairs |= 1 << idx;
                            ++lengthCounter;
                            activatedEffects[idx].Activate(character, calcs, ref currentSpellPower, ref baseHit, ref currentCrit, ref currentHaste, ref currentMastery);
                        }
                        currentCrit = (float)Math.Min(1.0f, currentCrit);
                        float tempDPS = rot.DamageDone(character, calcs, calcOpts.TreantLifespan, currentSpellPower, baseHit, currentCrit, currentHaste, currentMastery, calcOpts.Latency) / rot.RotationData.Duration;
                        spellDetails[0] = rot.RotationData.StarfireAvgHit;
                        spellDetails[1] = rot.RotationData.WrathAvgHit;
                        spellDetails[2] = rot.RotationData.MoonfireAvgHit;
                        spellDetails[3] = rot.RotationData.InsectSwarmAvgHit;
                        spellDetails[4] = rot.RotationData.StarSurgeAvgHit;
                        spellDetails[5] = rot.RotationData.StarfireAvgCast;
                        spellDetails[6] = rot.RotationData.WrathAvgCast;
                        spellDetails[7] = rot.RotationData.MoonfireAvgCast;
                        spellDetails[8] = rot.RotationData.InsectSwarmAvgCast;
                        spellDetails[9] = rot.RotationData.StarSurgeAvgCast;
                        spellDetails[10] = rot.RotationData.AverageInstantCast;
                        spellDetails[11] = rot.RotationData.StarfireAvgEnergy;
                        spellDetails[12] = rot.RotationData.WrathAvgEnergy;
                        spellDetails[13] = rot.RotationData.StarSurgeAvgEnergy;
                        spellDetails[14] = rot.RotationData.TreantDamage;
                        spellDetails[15] = rot.RotationData.StarfallDamage;
                        spellDetails[16] = rot.RotationData.MushroomDamage;
                        foreach (int idx in vals)
                        {
                            tempUpTime *= activatedEffects[idx].UpTime(rot, calcs, character.BossOptions.BerserkTimer, (float)(character.BossOptions.Under35Perc + character.BossOptions.Under20Perc));
                            activatedEffects[idx].Deactivate(character, calcs, ref currentSpellPower, ref baseHit, ref currentCrit, ref currentHaste, ref currentMastery);
                        }
                        if (tempUpTime == 0) continue;
                        // Adjust previous probability tables by the current factor
                        // At the end of the algorithm, this ensures that the probability table will contain the individual
                        // probabilities of each effect or set of effects.
                        // These adjustments only need to be made for higher levels of the table, and if the current probability is > 0.
                        if (lengthCounter > 1)
                        {
                            foreach (int subset in calculatedPairs)
                            {
                                // Truly a subset?
                                if ((pairs & subset) != subset)
                                {
                                    continue;
                                }

                                // Calculate the "layer" of the current subset by getting the set bit count.
                                int subsetLength = 0;
                                for (int j = subset; j > 0; ++subsetLength)
                                {
                                    j &= --j;
                                }

                                // Set the sign of the operation: Evenly separated layers are added, oddly separated layers are subtracted
                                int newSign = ((lengthCounter - subsetLength) % 2 == 0) ? 1 : -1;

                                // Adjust by current uptime * sign of operation.
                                cachedUptimes[subset] += newSign * tempUpTime;
                            }
                        }
                        // Cache the results to be calculated later
                        cachedUptimes[pairs] = tempUpTime;
                        cachedDamages[pairs] = tempDPS;
                        for (int idx = 0; idx < NUM_SPELL_DETAILS; ++idx)
                        {
                            cachedDetails[pairs, idx] = spellDetails[idx];
                        }
                        calculatedPairs.Add(pairs);
                        totalUpTime += sign * tempUpTime;
                    }
                    sign = -sign;
                }
                float accumulatedDPS = 0.0f;
                Array.Clear(spellDetails, 0, spellDetails.Length);
                // Apply the above-calculated probabilities to the previously stored damage calculations and add to the result.
                for (int idx = 0; idx < cachedUptimes.Length; ++idx)
                {
                    if (cachedUptimes[idx] == 0) continue;
                    accumulatedDPS += cachedUptimes[idx] * cachedDamages[idx];
                    for (int i = 0; i < NUM_SPELL_DETAILS; ++i)
                    {
                        spellDetails[i] += cachedUptimes[idx] * cachedDetails[idx,i];
                    }
                }
                float damageDone = rot.DamageDone(character, calcs, calcOpts.TreantLifespan, currentSpellPower, baseHit, currentCrit, currentHaste, currentMastery, calcOpts.Latency);
                accumulatedDPS += (1 - totalUpTime) * damageDone / rot.RotationData.Duration;
                spellDetails[0] += (1 - totalUpTime) * rot.RotationData.StarfireAvgHit;
                spellDetails[1] += (1 - totalUpTime) * rot.RotationData.WrathAvgHit;
                spellDetails[2] += (1 - totalUpTime) * rot.RotationData.MoonfireAvgHit;
                spellDetails[3] += (1 - totalUpTime) * rot.RotationData.InsectSwarmAvgHit;
                spellDetails[4] += (1 - totalUpTime) * rot.RotationData.StarSurgeAvgHit;
                spellDetails[5] += (1 - totalUpTime) * rot.RotationData.StarfireAvgCast;
                spellDetails[6] += (1 - totalUpTime) * rot.RotationData.WrathAvgCast;
                spellDetails[7] += (1 - totalUpTime) * rot.RotationData.MoonfireAvgCast;
                spellDetails[8] += (1 - totalUpTime) * rot.RotationData.InsectSwarmAvgCast;
                spellDetails[9] += (1 - totalUpTime) * rot.RotationData.StarSurgeAvgCast;
                spellDetails[10] += (1 - totalUpTime) * rot.RotationData.AverageInstantCast;
                spellDetails[11] += (1 - totalUpTime) * rot.RotationData.StarfireAvgEnergy;
                spellDetails[12] += (1 - totalUpTime) * rot.RotationData.WrathAvgEnergy;
                spellDetails[13] += (1 - totalUpTime) * rot.RotationData.StarSurgeAvgEnergy;
                spellDetails[14] += (1 - totalUpTime) * rot.RotationData.TreantDamage;
                spellDetails[15] += (1 - totalUpTime) * rot.RotationData.StarfallDamage;
                spellDetails[16] += (1 - totalUpTime) * rot.RotationData.MushroomDamage;

                float burstDPS = accumulatedDPS + accumulatedDamage / rot.RotationData.Duration;
                float sustainedDPS = burstDPS;

                // Mana calcs:
                // Main rotation - all spells
                // Movement rotation - Lunar Shower MF, IS, Shooting Stars procs, and Starfall only
                rot.RotationData.ManaGained += manaGained / (character.BossOptions.BerserkTimer * 60.0f) * rot.RotationData.Duration;
                float timeToOOM = manaPool / ((rot.RotationData.ManaUsed - rot.RotationData.ManaGained) / rot.RotationData.Duration);
                if (timeToOOM <= 0) timeToOOM = character.BossOptions.BerserkTimer * 60.0f;   // Happens when ManaUsed is less than 0
                if (timeToOOM < character.BossOptions.BerserkTimer * 60.0f)
                {
                    rot.RotationData.TimeToOOM = new TimeSpan(0, (int)(timeToOOM / 60), (int)(timeToOOM % 60));
                    sustainedDPS = burstDPS * timeToOOM / (character.BossOptions.BerserkTimer * 60.0f);
                }
                
                burstDPS += currentTrinketDPS;
                sustainedDPS += currentTrinketDPS;

                rot.RotationData.SustainedDPS = sustainedDPS;
                rot.RotationData.BurstDPS = burstDPS;
                rot.RotationData.StarfireAvgHit = spellDetails[0];
                rot.RotationData.WrathAvgHit = spellDetails[1];
                rot.RotationData.MoonfireAvgHit = spellDetails[2];
                rot.RotationData.InsectSwarmAvgHit = spellDetails[3];
                rot.RotationData.StarSurgeAvgHit = spellDetails[4];
                rot.RotationData.StarfireAvgCast = spellDetails[5];
                rot.RotationData.WrathAvgCast = spellDetails[6];
                rot.RotationData.MoonfireAvgCast = spellDetails[7];
                rot.RotationData.InsectSwarmAvgCast = spellDetails[8];
                rot.RotationData.StarSurgeAvgCast = spellDetails[9];
                rot.RotationData.AverageInstantCast = spellDetails[10];
                rot.RotationData.StarfireAvgEnergy = spellDetails[11];
                rot.RotationData.WrathAvgEnergy = spellDetails[12];
                rot.RotationData.StarSurgeAvgEnergy = spellDetails[13];
                rot.RotationData.TreantDamage = spellDetails[14];
                rot.RotationData.StarfallDamage = spellDetails[15];
                rot.RotationData.MushroomDamage = spellDetails[16];

                // Update the sustained DPS rotation if any one of the following three cases is true:
                // 1) No user rotation is selected and sustained DPS is maximum
                // 2) A user rotation is selected, Eclipse is not present, and the user rotation matches the current rotation
                // 3) A user rotation is selected, Eclipse is present, and the user rotation's dot spells matches this rotation's
                if ((calcOpts.UserRotation == "None" && sustainedDPS > maxDamageDone) || rot.RotationData.Name == calcOpts.UserRotation)
                {
                    maxDamageDone = sustainedDPS;
                    maxRotation = rot;
                }
                if (burstDPS > maxBurstDamageDone)
                {
                    maxBurstDamageDone = burstDPS;
                    maxBurstRotation = rot;
                }
                cachedResults[rotationIndex - 1] = rot.RotationData;

                // Deactivate always-up procs
                foreach (ProcEffect proc in alwaysUpEffects)
                {
                    proc.Deactivate(character, calcs, ref currentSpellPower, ref baseHit, ref currentCrit, ref currentHaste, ref currentMastery);
                }

                ++rotationIndex;
            }
            // Present the findings to the user.
            calcs.SelectedRotation = maxRotation.RotationData;
            calcs.BurstRotation = maxBurstRotation.RotationData;
            calcs.SubPoints = new float[] { maxBurstDamageDone, maxDamageDone };
            calcs.OverallPoints = calcs.SubPoints[0] + calcs.SubPoints[1];
            calcs.Rotations = cachedResults;
        }

        // Create proc effect calculations for proc-based trinkets.
        private void BuildProcList(CharacterCalculationsMoonkin calcs)
        {
            // Implement a new handler for each special effect in the calculations stats
            foreach (SpecialEffect effect in calcs.BasicStats.SpecialEffects())
            {
                procEffects.Add(new ProcEffect(effect));
            }
        }

        // Non-rotation-specific mana calculations
        private float GetEffectiveManaPool(Character character, CalculationOptionsMoonkin calcOpts, CharacterCalculationsMoonkin calcs)
        {
            float fightLength = character.BossOptions.BerserkTimer * 60.0f;

            float innervateCooldown = 180;

            // Mana/5 calculations
            float totalManaRegen = calcs.ManaRegen * fightLength;

            // Mana pot calculations
            float manaRestoredByPots = 0.0f;
            foreach (Buff b in character.ActiveBuffs)
            {
                if (b.Stats.ManaRestore > 0)
                {
                    manaRestoredByPots = b.Stats.ManaRestore;
                    break;
                }
            }

            // Innervate calculations
            float innervateDelay = calcOpts.InnervateDelay * 60.0f;
            int numInnervates = (calcOpts.Innervate && fightLength - innervateDelay > 0) ? ((int)(fightLength - innervateDelay) / (int)innervateCooldown + 1) : 0;
            float totalInnervateMana = numInnervates * 0.2f * calcs.BasicStats.Mana;
            totalInnervateMana *= 1 + 0.15f * character.DruidTalents.Dreamstate;

            // Replenishment calculations
            float replenishmentPerTick = calcs.BasicStats.Mana * calcs.BasicStats.ManaRestoreFromMaxManaPerSecond;
            float replenishmentMana = calcOpts.ReplenishmentUptime * replenishmentPerTick * character.BossOptions.BerserkTimer * 60;

            return calcs.BasicStats.Mana + totalInnervateMana + totalManaRegen + manaRestoredByPots + replenishmentMana;
        }

        /*private void RecreateRotations()
        {
            rotations[0] = new SpellRotation() { RotationData = new RotationData() { Name = "None" } };
            for (int mfMode = 0; mfMode < 2; ++mfMode)
            {
                for (int isMode = 0; isMode < 2; ++isMode)
                {
                    for (int sfMode = 0; sfMode < 3; ++sfMode)
                    {
                        for (int wmMode = 0; wmMode < 3; ++wmMode)
                        {
                            int index = 1 + (wmMode + 3 * sfMode + 9 * isMode + 18 * mfMode);
                            DotMode mfModeEnum = (DotMode)mfMode;
                            DotMode isModeEnum = (DotMode)isMode;
                            StarfallMode sfModeEnum = (StarfallMode)sfMode;
                            MushroomMode wmModeEnum = (MushroomMode)wmMode;
                            string name = String.Format("MF {0} IS {1} SF {2} WM {3}",
                                mfModeEnum.ToString(),
                                isModeEnum.ToString(),
                                sfModeEnum.ToString(),
                                wmModeEnum.ToString());
                            rotations[index] = new SpellRotation()
                            {
                                RotationData = new RotationData()
                                {
                                    Name = name,
                                    MoonfireRefreshMode = mfModeEnum,
                                    InsectSwarmRefreshMode = isModeEnum,
                                    StarfallCastMode = sfModeEnum,
                                    WildMushroomCastMode = wmModeEnum
                                }
                            };
                        }
                    }
                }
            }
        }*/

        // Add talented effects to the spells
        private void UpdateSpells(Character character, ref CharacterCalculationsMoonkin calcs)
        {
            DruidTalents talents = character.DruidTalents;
            StatsMoonkin stats = calcs.BasicStats;

            switch (talents.StarlightWrath)
            {
                case 1:
                    Starfire.BaseCastTime -= 0.15f;
                    Wrath.BaseCastTime -= 0.15f;
                    break;
                case 2:
                    Starfire.BaseCastTime -= 0.25f;
                    Wrath.BaseCastTime -= 0.25f;
                    break;
                case 3:
                    Starfire.BaseCastTime -= 0.5f;
                    Wrath.BaseCastTime -= 0.5f;
                    break;
                default:
                    break;
            }

            float moonfireDotGlyph = talents.GlyphOfMoonfire ? 0.2f : 0.0f;
            float insectSwarmGlyph = talents.GlyphOfInsectSwarm ? 0.3f : 0.0f;
            // Add spell-specific damage
            // Moonfire, Insect Swarm: glyphs
            Moonfire.DotEffect.AllDamageModifier *= 1 + moonfireDotGlyph;
            InsectSwarm.DotEffect.AllDamageModifier *= 1 + insectSwarmGlyph;
            // Moonfire: Direct damage +(0.03 * Blessing of the Grove)
            Moonfire.AllDamageModifier *= 1 + 0.03f * talents.BlessingOfTheGrove;
            // Moonfire, Insect Swarm: +2/4/6 seconds for Genesis
            Moonfire.DotEffect.BaseDuration += 2f * talents.Genesis;
            InsectSwarm.DotEffect.BaseDuration += 2f * talents.Genesis;
            // Wrath: 10% for glyph
            Wrath.AllDamageModifier *= 1 + (talents.GlyphOfWrath ? 0.1f : 0f);

            // Add spell-specific critical strike damage
            // Burning Shadowspirit Diamond
            float baseCritMultiplier = 1.5f * (1 + stats.BonusCritDamageMultiplier);
            float moonfuryMultiplier = baseCritMultiplier + (baseCritMultiplier - 1);
            Starfire.CriticalDamageModifier = Wrath.CriticalDamageModifier = Moonfire.CriticalDamageModifier = InsectSwarm.CriticalDamageModifier = moonfuryMultiplier;
            Starsurge.CriticalDamageModifier = moonfuryMultiplier;

            // Reduce spell-specific mana costs
            // Shard of Woe (Mana cost -405)
            Starfire.BaseManaCost -= calcs.BasicStats.SpellsManaCostReduction;
            Moonfire.BaseManaCost -= calcs.BasicStats.SpellsManaCostReduction;
            Wrath.BaseManaCost -= calcs.BasicStats.SpellsManaCostReduction + calcs.BasicStats.NatureSpellsManaCostReduction;
            InsectSwarm.BaseManaCost -= calcs.BasicStats.SpellsManaCostReduction + calcs.BasicStats.NatureSpellsManaCostReduction;
            Starsurge.BaseManaCost -= calcs.BasicStats.SpellsManaCostReduction;
            // All spells: Mana cost -(0.03 * Moonglow)
            Starfire.BaseManaCost *= 1.0f - (0.03f * talents.Moonglow);
            Moonfire.BaseManaCost *= 1.0f - (0.03f * talents.Moonglow);
            Wrath.BaseManaCost *= 1.0f - (0.03f * talents.Moonglow);
            InsectSwarm.BaseManaCost *= 1.0f - (0.03f * talents.Moonglow);
            Starsurge.BaseManaCost *= 1.0f - (0.03f * talents.Moonglow);

            // Add set bonuses
            Moonfire.CriticalChanceModifier += stats.BonusCritChanceMoonfire;
            InsectSwarm.CriticalChanceModifier += stats.BonusCritChanceInsectSwarm;
            Starfire.AllDamageModifier *= 1 + stats.BonusNukeDamageModifier;
            Wrath.AllDamageModifier *= 1 + stats.BonusNukeDamageModifier;
            Starsurge.AllDamageModifier *= 1 + stats.BonusNukeDamageModifier;

            // Dragonwrath, Tarecgosa's Rest: X% chance on damaging spell cast to proc a duplicate version of the spell.
            // If it duplicates a DoT tick, it fires Wrath of Tarecgosa for an equivalent amount of damage.
            // Wrath, Starfire, and Starsurge will duplicate the Eclipse energy gained.
            if (calcs.BasicStats.DragonwrathProc > 0)
            {
                Starfire.AllDamageModifier += MoonkinSolver.DRAGONWRATH_PROC_RATE;
                Wrath.AllDamageModifier += MoonkinSolver.DRAGONWRATH_PROC_RATE;
                Starsurge.AllDamageModifier += MoonkinSolver.DRAGONWRATH_PROC_RATE;
                Moonfire.AllDamageModifier += MoonkinSolver.DRAGONWRATH_PROC_RATE;
                Moonfire.DotEffect.AllDamageModifier += MoonkinSolver.DRAGONWRATH_PROC_RATE;
                InsectSwarm.DotEffect.AllDamageModifier += MoonkinSolver.DRAGONWRATH_PROC_RATE;
            }

            // PTR changes go here
            if (((CalculationOptionsMoonkin)character.CalculationOptions).PTRMode)
            {
            }
        }
    }
}
